apiVersion: 1

groups:
  - orgId: 1
    name: korea-public-api
    folder: Alerts
    interval: 1m
    rules:
      - uid: http-5xx-rate
        title: High 5xx error rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_status_codes_total{status_code=~"5.."}[5m]))
              instant: false
              interval: ""
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_status_codes_total[5m]))
              instant: false
              interval: ""
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: -100
            model:
              type: math
              expression: A / B
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "5xx error rate is above 5%"
        labels:
          severity: critical
        isPaused: false
        notification_settings:
          receiver: discord
      - uid: http-5xx-rate-slack
        title: High 5xx error rate (Slack)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_status_codes_total{status_code=~"5.."}[5m]))
              instant: false
              interval: ""
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(http_status_codes_total[5m]))
              instant: false
              interval: ""
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: -100
            model:
              type: math
              expression: A / B
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "5xx error rate is above 5%"
        labels:
          severity: critical
        isPaused: false
        notification_settings:
          receiver: slack

      - uid: http-latency-p99
        title: High latency p99
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
              instant: false
              interval: ""
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "p99 latency > 1s"
        labels:
          severity: warning
        isPaused: false
        notification_settings:
          receiver: discord
      - uid: http-latency-p99-slack
        title: High latency p99 (Slack)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
              instant: false
              interval: ""
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "p99 latency > 1s"
        labels:
          severity: warning
        isPaused: false
        notification_settings:
          receiver: slack

